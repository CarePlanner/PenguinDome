# Maintainer: Quantopian Inc. <dev@quantopian.com>

pkgname=qlmdm-client
pkgver=1.0.0
pkgrel=0
pkgdesc="Quantopian Linux Mobile Device Management Client"
arch=('x86_64')
url="https://www.github.com/quantopian/qlmdm"
depends=('python'
         'python-certifi'
         'python-chardet'
         'python-dateutil',
         'python-fasteners'
         'python-idna'
         'python-netifaces'
         'python-psutil'
         'python-pymongo'
         'python-yaml'
         'python-requests'
         # 'python-stopit' also needed, but doesn't exist
         'python-urllib3'
         'python-logbook-quantopian'
         'coreutils'
         'cryptsetup'
	 'dmidecode'
         'gnupg'
         'iptables'
         'lvm2'
	 'systemd'
         'tar'
         'wireless_tools'
         'util-linux')
source=("http://eraserver.dynoquant.com:5001/qlmdm/v1/download_release")
sha256sums=(SKIP)
install=qlmdm-client.install

package() {
  cd ${srcdir}

  real_install_dir="/opt/qlmdm"
  install_dir="$pkgdir/$real_install_dir"

  install -d ${install_dir}
  cp -r . ${install_dir}

  chmod -R 700 "$install_dir/client/keyring"

  site=$(python -c "import site;print(site.getsitepackages()[0])")

  for dir in ${site}; do
    install -d "$pkgdir/$dir"
    echo ${real_install_dir} > "$pkgdir/$dir/qlmdm.pth"
  done

  install -d ${install_dir}/bin
  for file in client/*.py; do
    tail=${file##*/}
    if [ $tail = "initialize.py" ]; then
      continue
    fi
    chmod 754 $install_dir/$file
    ln -sf ../$file "$install_dir/bin/${tail%.py}"
  done

  install -Dm644 client/qlmdm-client.service "$pkgdir/etc/systemd/system/qlmdm-client.service"
  install -Dm644 client/qlmdm-client.timer "$pkgdir/etc/systemd/system/qlmdm-client.timer"
}
