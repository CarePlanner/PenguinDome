# Maintainer: Quantopian Inc. <dev@quantopian.com>

pkgname=qlmdm-client
pkgver=1.0.0
pkgrel=0
pkgdesc="Quantopian Linux Mobile Device Management Client"
arch=('x86_64')
url="https://www.github.com/quantopian/qlmdm"
depends=('python'
         'python-certifi'
         'python-chardet'
         'python-idna'
         'python-netifaces'
         'python-psutil'
         'python-pymongo'
         'python-yaml'
         'python-requests'
         'python-urllib3'
         'python-logbook-quantopian'
         'cryptsetup'
         'gnupg'
         'iptables'
         'lvm2'
         'procps-ng'
         'tar'
         'wireless_tools'
         'util-linux')
source=("http://eraserver.dynoquant.com:5001/qlmdm/v1/download_release")
sha256sums=(SKIP)

package() {
  cd ${srcdir}

  real_install_dir="/opt/qlmdm"
  install_dir="$pkgdir/$real_install_dir"

  install -d ${install_dir}
  cp -r . ${install_dir}

  site=$(python -c "import site;print(site.getsitepackages()[0])")

  for dir in ${site}; do
    install -d "$pkgdir/$dir"
    echo ${real_install_dir} > "$pkgdir/$dir/qlmdm.pth"
  done

  for file in client/*.py; do
    tail=${file##*/}
    if [ $tail = "initialize.py" ]; then
      continue
    fi
    install -Dm554 ${file} "$install_dir/bin/${tail%.py}"
  done

  install -D client/qlmdm-client.service "$pkgdir/etc/systemd/system/qlmdm-client.service"
  install -D client/qlmdm-client.timer "$pkgdir/etc/systemd/system/qlmdm-client.timer"
}

post_install() {
    echo 'starting qlmdm-client.timer'
    systemctl enable qlmdm-client.timer
    systemctl start qlmdm-client.timer
}